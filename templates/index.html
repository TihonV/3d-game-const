<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-studio Constructor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #222;
            color: white;
            overflow: hidden;
        }

        #constructor {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: #111;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #exportButtons button, #previewBtn, #loadUserModelBtn, #addComponentBtn {
            margin-left: 10px;
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .main-layout {
            display: flex;
            flex: 1;
        }

        #editorPanel {
            width: 350px;
            background-color: #333;
            padding: 15px;
            overflow-y: auto;
        }

        #editorPanel input, button, select, textarea {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
        }

        #gameContainer {
            flex: 1;
            position: relative;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 4px;
            font-size: 18px;
            z-index: 100;
        }

        .modal {
            display: flex;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #333;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            max-width: 500px;
        }

        .tutorial-options button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
        }

        #startTutorial {
            background-color: #4CAF50;
            color: white;
        }

        #skipTutorial {
            background-color: #ccc;
            color: black;
        }

        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted white;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1001;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .layer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background-color: #444;
            margin-bottom: 5px;
        }

        .layer-toggle {
            width: auto;
        }

        .resource-item {
            padding: 5px;
            background-color: #444;
            margin-bottom: 5px;
        }

        #errorConsole {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 100;
            max-width: 400px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="constructor">
        <header>
            <h1>T-studio Game Constructor</h1>
            <div id="exportButtons">
                <button id="downloadHTML">Download HTML</button>
                <button id="previewBtn">Предпросмотр</button>
            </div>
        </header>

        <div class="main-layout">
            <div id="editorPanel">
                <h3>Editor</h3>

                <!-- Шаблоны -->
                <div class="editor-section">
                    <label class="tooltip">
                        Шаблон игры
                        <span class="tooltiptext">Выберите шаблон для быстрого старта</span>
                    </label>
                    <select id="templateSelect">
                        <option value="">Выберите шаблон</option>
                        <option value="forest">Лес</option>
                        <option value="room">Комната</option>
                        <option value="platformer">Платформер</option>
                    </select>
                    <button id="applyTemplate">Применить</button>
                </div>

                <!-- Загрузка пользовательской модели -->
                <div class="editor-section">
                    <label class="tooltip">
                        Загрузить свою 3D-модель
                        <span class="tooltiptext">Загрузите .gltf/.glb файл</span>
                    </label>
                    <input type="file" id="modelFile" accept=".gltf,.glb">
                    <button id="loadUserModelBtn">Загрузить модель</button>
                </div>

                <!-- Добавить свой объект -->
                <div class="editor-section">
                    <label class="tooltip">
                        Добавить свой объект
                        <span class="tooltiptext">Создайте объект с настройками</span>
                    </label>
                    <button id="addComponentBtn">Добавить компонент</button>
                </div>

                <!-- Палитра цветов -->
                <div class="editor-section">
                    <label class="tooltip">
                        Цвет фона
                        <span class="tooltiptext">Изменить цвет фона сцены</span>
                    </label>
                    <input type="color" id="bgColorPicker" value="#87CEEB">
                </div>

                <!-- Поведение -->
                <div class="editor-section">
                    <label class="tooltip">
                        Поведение объекта
                        <span class="tooltiptext">Выберите поведение для выделенного объекта</span>
                    </label>
                    <select id="behaviorSelect">
                        <option value="">Нет поведения</option>
                        <option value="jump">Прыжок</option>
                        <option value="follow">Следование за камерой</option>
                        <option value="rotate">Вращение</option>
                    </select>
                </div>

                <!-- Слои -->
                <div class="editor-section">
                    <label class="tooltip">
                        Слои объектов
                        <span class="tooltiptext">Включить/выключить отображение слоёв</span>
                    </label>
                    <div id="layersList"></div>
                </div>

                <!-- Ресурсы -->
                <div class="editor-section">
                    <label class="tooltip">
                        Загруженные ресурсы
                        <span class="tooltiptext">Список всех загруженных моделей</span>
                    </label>
                    <div id="resourcesList"></div>
                </div>

                <!-- Импорт/Экспорт -->
                <div class="editor-section">
                    <label class="tooltip">
                        Проект
                        <span class="tooltiptext">Сохранить или загрузить проект</span>
                    </label>
                    <input type="file" id="importProject" accept=".json">
                    <button id="exportProject">Экспорт проекта</button>
                </div>
            </div>

            <div id="gameContainer">
                <canvas id="gameCanvas"></canvas>
                <div id="madeBy" class="overlay" style="display:none;">Made by T-studio</div>
                <div id="errorConsole">Ошибка: за помощью — обращаться к qwen.ai</div>
            </div>
        </div>
    </div>

    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <h2>Добро пожаловать в T-studio Constructor!</h2>
            <p>Вы хотите пройти обучающий курс, чтобы создать свою первую 3D-игру?</p>
            <div class="tutorial-options">
                <button id="startTutorial">Да, начать обучение</button>
                <button id="skipTutorial">Пропустить</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
    <script>
        let scene, camera, renderer, controls;
        let objects = [];
        let layers = {};
        let resources = [];
        let selectedObject = null;

        function initScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);

            renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('gameCanvas'), antialias: true });
            renderer.setSize(document.getElementById('gameContainer').clientWidth, document.getElementById('gameContainer').clientHeight);
            renderer.shadowMap.enabled = true;

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            const planeGeometry = new THREE.PlaneGeometry(20, 20);
            const planeMaterial = new THREE.MeshStandardMaterial({ color: 0x2E8B57 });
            const plane = new THREE.Mesh(planeGeometry, planeMaterial);
            plane.rotation.x = -Math.PI / 2;
            plane.receiveShadow = true;
            scene.add(plane);
            objects.push(plane);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        function addLight() {
            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(10, 20, 10);
            light.castShadow = true;
            scene.add(light);
        }

        function applyTemplate() {
            const template = document.getElementById('templateSelect').value;
            if (template === 'forest') {
                const treeGeometry = new THREE.ConeGeometry(1, 4, 8);
                const treeMaterial = new THREE.MeshStandardMaterial({ color: 0x228B22 });
                const tree = new THREE.Mesh(treeGeometry, treeMaterial);
                tree.position.set(2, 2, 0);
                scene.add(tree);
                objects.push(tree);
            } else if (template === 'room') {
                const wallGeometry = new THREE.BoxGeometry(10, 5, 0.2);
                const wallMaterial = new THREE.MeshStandardMaterial({ color: 0x808080 });
                for (let i = 0; i < 4; i++) {
                    const wall = new THREE.Mesh(wallGeometry, wallMaterial);
                    wall.position.set(i % 2 === 0 ? (i - 1) * 5 : 0, 2.5, i % 2 !== 0 ? (i - 2) * 5 : 0);
                    wall.rotation.y = i % 2 === 0 ? 0 : Math.PI / 2;
                    scene.add(wall);
                    objects.push(wall);
                }
            } else if (template === 'platformer') {
                for (let i = 0; i < 3; i++) {
                    const platformGeometry = new THREE.BoxGeometry(3, 0.5, 3);
                    const platformMaterial = new THREE.MeshStandardMaterial({ color: 0xFFD700 });
                    const platform = new THREE.Mesh(platformGeometry, platformMaterial);
                    platform.position.set(i * 4, i * 1.5, 0);
                    platform.castShadow = true;
                    scene.add(platform);
                    objects.push(platform);
                }
            }
            updateLayersList();
        }

        function updateLayersList() {
            const layersList = document.getElementById('layersList');
            layersList.innerHTML = '';
            objects.forEach((obj, index) => {
                const div = document.createElement('div');
                div.className = 'layer-item';
                div.innerHTML = `
                    <span>Объект ${index}</span>
                    <input type="checkbox" class="layer-toggle" data-index="${index}" checked>
                `;
                layersList.appendChild(div);
            });

            document.querySelectorAll('.layer-toggle').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.index);
                    objects[idx].visible = e.target.checked;
                });
            });
        }

        function updateResourcesList() {
            const resourcesList = document.getElementById('resourcesList');
            resourcesList.innerHTML = '';
            resources.forEach((res, index) => {
                const div = document.createElement('div');
                div.className = 'resource-item';
                div.textContent = res.name;
                resourcesList.appendChild(div);
            });
        }

        function loadUserModel() {
            const fileInput = document.getElementById('modelFile');
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const contents = e.target.result;
                const blob = new Blob([contents], { type: 'model/gltf-binary' });
                const url = URL.createObjectURL(blob);

                const loader = new THREE.GLTFLoader();
                loader.load(
                    url,
                    (gltf) => {
                        const model = gltf.scene;
                        model.position.set(0, 1, 0);
                        scene.add(model);
                        objects.push(model);
                        resources.push({ name: file.name, url });
                        updateLayersList();
                        updateResourcesList();
                    },
                    undefined,
                    (error) => {
                        showError("Ошибка загрузки модели: " + error.message);
                    }
                );
            };
            reader.readAsArrayBuffer(file);
        }

        function showError(msg) {
            const errorDiv = document.getElementById('errorConsole');
            errorDiv.textContent = msg;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function downloadGameAsHTML() {
            const html = `
<!DOCTYPE html>
<html>
<head>
    <title>My Game - Made with T-studio</title>
    <style>
        body { margin: 0; overflow: hidden; }
        #madeBy { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 10px; z-index: 100; }
    </style>
</head>
<body>
    <div id="madeBy">Made by T-studio</div>
    <canvas id="gameCanvas"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        let camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 10);
        let renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('gameCanvas') });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;

        const planeGeometry = new THREE.PlaneGeometry(20, 20);
        const planeMaterial = new THREE.MeshStandardMaterial({ color: 0x2E8B57 });
        const plane = new THREE.Mesh(planeGeometry, planeMaterial);
        plane.rotation.x = -Math.PI / 2;
        plane.receiveShadow = true;
        scene.add(plane);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(10, 20, 10);
        light.castShadow = true;
        scene.add(light);

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
            `;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my-game.html';
            a.click();
        }

        function previewGame() {
            const html = `<div id="madeBy">Made by T-studio</div><canvas id="gameCanvas"></canvas>`;
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <html>
                <head>
                    <title>Предпросмотр игры</title>
                    <style>body { margin:0; }</style>
                </head>
                <body>
                    ${html}
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script>
                    <script>
                        let scene = new THREE.Scene();
                        scene.background = new THREE.Color(0x87CEEB);
                        let camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                        camera.position.set(0, 5, 10);
                        let renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('gameCanvas') });
                        renderer.setSize(window.innerWidth, window.innerHeight);
                        renderer.shadowMap.enabled = true;

                        const planeGeometry = new THREE.PlaneGeometry(20, 20);
                        const planeMaterial = new THREE.MeshStandardMaterial({ color: 0x2E8B57 });
                        const plane = new THREE.Mesh(planeGeometry, planeMaterial);
                        plane.rotation.x = -Math.PI / 2;
                        plane.receiveShadow = true;
                        scene.add(plane);

                        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                        scene.add(ambientLight);
                        const light = new THREE.DirectionalLight(0xffffff, 1);
                        light.position.set(10, 20, 10);
                        light.castShadow = true;
                        scene.add(light);

                        function animate() {
                            requestAnimationFrame(animate);
                            renderer.render(scene, camera);
                        }
                        animate();

                        window.addEventListener('resize', () => {
                            camera.aspect = window.innerWidth / window.innerHeight;
                            camera.updateProjectionMatrix();
                            renderer.setSize(window.innerWidth, window.innerHeight);
                        });
                    <\/script>
                </body>
                </html>
            `);
        }

        function exportProject() {
            const project = {
                objects: objects.map(obj => obj.toJSON()),
                background: scene.background.getHex()
            };
            const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'project.json';
            a.click();
        }

        function importProject() {
            const fileInput = document.getElementById('importProject');
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const project = JSON.parse(e.target.result);
                    scene.background = new THREE.Color(project.background);
                    // В реальном конструкторе нужно восстановить объекты
                    showError("Проект импортирован (объекты не восстановлены в этом демо).");
                } catch (err) {
                    showError("Ошибка импорта: " + err.message);
                }
            };
            reader.readAsText(file);
        }

        function isNewUser() {
            return !localStorage.getItem('hasVisited');
        }

        function startTutorial() {
            localStorage.setItem('hasVisited', 'true');
            document.getElementById('tutorialModal').style.display = 'none';
            document.getElementById('madeBy').style.display = 'block';

            const steps = [
                { text: "Добро пожаловать! Давайте создадим вашу первую 3D-сцену.", action: null },
                { text: "Выберите шаблон игры и нажмите 'Применить'.", action: () => {
                    document.getElementById('templateSelect').style.border = '2px solid yellow';
                }},
                { text: "Теперь загрузите свою 3D-модель или добавьте компонент.", action: () => {
                    document.getElementById('addComponentBtn').style.backgroundColor = '#FF5722';
                }},
                { text: "Готово! Вы можете скачать игру или открыть предпросмотр.", action: () => {
                    document.getElementById('downloadHTML').style.backgroundColor = '#FF5722';
                }}
            ];

            let currentStep = 0;
            function speak(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ru-RU';
                    speechSynthesis.speak(utterance);
                }
            }

            function nextStep() {
                if (currentStep < steps.length) {
                    const step = steps[currentStep];
                    speak(step.text);
                    if (step.action) step.action();
                    currentStep++;
                } else {
                    document.getElementById('templateSelect').style.border = '';
                    document.getElementById('addComponentBtn').style.backgroundColor = '#4CAF50';
                    document.getElementById('downloadHTML').style.backgroundColor = '#4CAF50';
                }
            }

            nextStep();
            setInterval(nextStep, 5000);
        }

        window.addEventListener('resize', () => {
            camera.aspect = document.getElementById('gameContainer').clientWidth / document.getElementById('gameContainer').clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(document.getElementById('gameContainer').clientWidth, document.getElementById('gameContainer').clientHeight);
        });

        window.onload = function() {
            if (isNewUser()) {
                document.getElementById('tutorialModal').style.display = 'flex';
            } else {
                initScene();
            }
        };

        document.getElementById('startTutorial').addEventListener('click', startTutorial);
        document.getElementById('skipTutorial').addEventListener('click', () => {
            localStorage.setItem('hasVisited', 'true');
            document.getElementById('tutorialModal').style.display = 'none';
            initScene();
        });

        document.getElementById('applyTemplate').addEventListener('click', applyTemplate);
        document.getElementById('loadUserModelBtn').addEventListener('click', loadUserModel);
        document.getElementById('addComponentBtn').addEventListener('click', () => {
            const geometry = new THREE.BoxGeometry();
            const material = new THREE.MeshStandardMaterial({ color: Math.random() * 0xffffff });
            const cube = new THREE.Mesh(geometry, material);
            cube.position.set(Math.random() * 5, 1, Math.random() * 5);
            scene.add(cube);
            objects.push(cube);
            updateLayersList();
        });
        document.getElementById('bgColorPicker').addEventListener('input', (e) => {
            scene.background = new THREE.Color(e.target.value);
        });
        document.getElementById('downloadHTML').addEventListener('click', downloadGameAsHTML);
        document.getElementById('previewBtn').addEventListener('click', previewGame);
        document.getElementById('exportProject').addEventListener('click', exportProject);
        document.getElementById('importProject').addEventListener('change', importProject);

        // Автосохранение
        setInterval(() => {
            localStorage.setItem('currentProject', JSON.stringify(objects.map(o => o.toJSON())));
        }, 10000);
    </script>
</body>
</html>
